--- CMakeLists.txt.orig	2024-02-20 04:01:31 UTC
+++ CMakeLists.txt
@@ -1,5 +1,5 @@ cmake_minimum_required(VERSION 3.6)
 cmake_minimum_required(VERSION 3.6)
-project(moonlight-embedded VERSION 2.7.0 LANGUAGES C)
+project(moonlight-embedded VERSION 2.7.2 LANGUAGES C)
 SET(CMAKE_MODULE_PATH "${PROJECT_SOURCE_DIR}/cmake")
 SET(CMAKE_C_STANDARD 99)
 include(${CMAKE_ROOT}/Modules/GNUInstallDirs.cmake)
@@ -26,6 +26,7 @@ option(ENABLE_X11 "Compile X11 support (requires ENABL
 option(ENABLE_SDL "Compile SDL support" ON)
 option(ENABLE_FFMPEG "Compile FFMPEG support" ON)
 option(ENABLE_X11 "Compile X11 support (requires ENABLE_FFMPEG)" ON)
+option(ENABLE_WAYLAND "Compile WAYLAND support (requires ENABLE_FFMPEG)" ON)
 option(ENABLE_CEC "Compile CEC support" ON)
 option(ENABLE_PULSE "Compile PulseAudio support" ON)
 
@@ -46,6 +47,11 @@ if (ENABLE_FFMPEG)
     pkg_check_modules(XLIB x11)
     pkg_check_modules(LIBVA_X11 libva-x11)
   endif()
+
+  if (ENABLE_WAYLAND)
+    pkg_check_modules(WAYLAND_CLIENT wayland-client)
+    pkg_check_modules(WAYLAND_EGL wayland-egl)
+  endif()
 endif()
 if (ENABLE_PULSE)
   pkg_check_modules(PULSE libpulse-simple)
@@ -179,6 +185,25 @@ if (SOFTWARE_FOUND)
     target_sources(moonlight PRIVATE ./src/video/x11.c ./src/video/egl.c ./src/input/x11.c)
     target_include_directories(moonlight PRIVATE ${XLIB_INCLUDE_DIRS} ${EGL_INCLUDE_DIRS} ${GLES_INCLUDE_DIRS})
     target_link_libraries(moonlight ${XLIB_LIBRARIES} ${EGL_LIBRARIES} ${GLES_LIBRARIES})
+  endif()
+  if(WAYLAND_CLIENT_FOUND AND WAYLAND_EGL_FOUND)
+    list(APPEND MOONLIGHT_DEFINITIONS HAVE_WAYLAND)
+    list(APPEND MOONLIGHT_OPTIONS WAYLAND)
+    find_path(WAYLAND_SCANNER_PATH wayland-scanner PATHS ${CMAKE_INSTALL_PREFIX}/${CMAKE_INSTALL_BINDIR} REQUIRED)
+    find_path(XDG_SHELL_PATH xdg-shell.xml PATHS ${CMAKE_INSTALL_PREFIX}/${CMAKE_INSTALL_DATADIR}/wayland-protocols/stable/xdg-shell REQUIRED)
+    find_path(VIEWPORTER_PATH viewporter.xml PATHS ${CMAKE_INSTALL_PREFIX}/${CMAKE_INSTALL_DATADIR}/wayland-protocols/stable/viewporter REQUIRED)
+    execute_process(COMMAND ${WAYLAND_SCANNER_PATH}/wayland-scanner client-header ${XDG_SHELL_PATH}/xdg-shell.xml ./src/video/xdg-shell-client-protocol.h
+                   COMMAND ${WAYLAND_SCANNER_PATH}/wayland-scanner private-code ${XDG_SHELL_PATH}/xdg-shell.xml ./src/video/xdg-shell-client-protocol.c
+                   COMMAND ${WAYLAND_SCANNER_PATH}/wayland-scanner client-header ${VIEWPORTER_PATH}/viewporter.xml ./src/video/wp-viewporter.h
+                   COMMAND ${WAYLAND_SCANNER_PATH}/wayland-scanner private-code ${VIEWPORTER_PATH}/viewporter.xml ./src/video/wp-viewporter.c
+                   WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
+                   TIMEOUT 9)
+    target_sources(moonlight PRIVATE ./src/video/wlr-output-management.c ./src/video/wp-viewporter.c ./src/video/xdg-shell-client-protocol.c ./src/video/wayland.c)
+    target_include_directories(moonlight PRIVATE ${WAYLAND_CLIENT_INCLUDE_DIRS} ${WAYLAND_EGL_INCLUDE_DIRS})
+    target_link_libraries(moonlight ${WAYLAND_CLIENT_LIBRARIES} ${WAYLAND_EGL_LIBRARIES})
+  endif()
+  if((X11_FOUND) OR (WAYLAND_CLIENT_FOUND AND WAYLAND_EGL_FOUND))
+    target_sources(moonlight PRIVATE ./src/video/pc.c)
   endif()
   if(VDPAU_ACCEL_FOUND)
     list(APPEND MOONLIGHT_DEFINITIONS HAVE_VDPAU)
